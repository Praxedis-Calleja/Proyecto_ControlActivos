<%- include('../layouts/base', { body: `
  <section class="incidencias-lista">
    <header class="incidencias-lista__header">
      <div>
        <h2>Incidencias registradas</h2>
        <p class="incidencias-lista__descripcion section-description">
          Revisa el estado de las incidencias reportadas, actualiza la información técnica y genera los reportes necesarios.
        </p>
      </div>
      <div class="incidencias-lista__acciones">
        <a class="btn" href="/incidencias/nueva">➕ Registrar incidencia</a>
      </div>
    </header>

    ${estadoActualizado ? '<div class="ok">Estado de la incidencia actualizado correctamente.</div>' : ''}
    ${estadoErrorActualizacion ? '<div class="alert">No se pudo actualizar el estado de la incidencia. Inténtalo nuevamente.</div>' : ''}
    ${error ? `<div class="alert">${error}</div>` : ''}

    ${(() => {
      const escapeHtml = (texto = '') =>
        String(texto)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const multilinea = (texto = '') =>
        escapeHtml(texto).replace(/\r?\n/g, '<br>');

      const escapeAttr = (texto = '') => escapeHtml(texto);

      const formatearEtiqueta = (valor = '') =>
        String(valor)
          .toLowerCase()
          .split('_')
          .map((segmento) => segmento.charAt(0).toUpperCase() + segmento.slice(1))
          .join(' ');

      const tokenCsrf = typeof csrfToken === 'string' ? csrfToken : '';

      const filtrosDatos = {
        estado: filtros && typeof filtros.estado === 'string' ? filtros.estado : '',
        busqueda: filtros && typeof filtros.busqueda === 'string' ? filtros.busqueda : '',
        hoy: Boolean(filtros && filtros.hoy)
      };

      const filtrosAplicados = Boolean(
        filtrosDatos.estado || filtrosDatos.busqueda || filtrosDatos.hoy
      );

      const opcionesFiltroEstado = ['', 'ABIERTA', 'EN_PROCESO', 'CERRADA']
        .map((valor) => {
          const selected = filtrosDatos.estado === valor ? ' selected' : '';
          const etiqueta = valor ? formatearEtiqueta(valor) : 'Todas';
          return `<option value="${escapeAttr(valor)}"${selected}>${escapeHtml(etiqueta)}</option>`;
        })
        .join('');

      const formularioFiltros = `
        <form class="incidencias-filtros" method="get">
          <div class="incidencias-filtros__grupo">
            <label for="filtro-estado">Estado</label>
            <select id="filtro-estado" name="estado">
              ${opcionesFiltroEstado}
            </select>
          </div>
          <div class="incidencias-filtros__grupo incidencias-filtros__grupo--busqueda">
            <label for="filtro-busqueda">Buscar</label>
            <input
              type="search"
              id="filtro-busqueda"
              name="q"
              value="${escapeAttr(filtrosDatos.busqueda)}"
              placeholder="Buscar por activo o descripción"
              autocomplete="off"
            >
          </div>
          <div class="incidencias-filtros__grupo incidencias-filtros__grupo--checkbox">
            <label class="incidencias-filtros__checkbox">
              <input type="checkbox" name="hoy" value="1"${filtrosDatos.hoy ? ' checked' : ''}>
              <span>Solo incidencias de hoy</span>
            </label>
          </div>
          <div class="incidencias-filtros__acciones">
            <button type="submit" class="btn">Aplicar filtros</button>
            <a class="btn-secundario" href="/incidencias">Limpiar</a>
          </div>
        </form>
      `;

      const incidenciasVisibles = Array.isArray(incidencias)
        ? incidencias.filter(
            (incidencia) =>
              String(incidencia.estado || '').toUpperCase() !== 'CANCELADA'
          )
        : [];

      if (incidenciasVisibles.length === 0) {
        if (error) {
          return `
            ${formularioFiltros}
            <div class="incidencias-vacia">
              <p>No pudimos cargar la lista de incidencias en este momento.</p>
            </div>
          `;
        }
        if (filtrosAplicados) {
          return `
            ${formularioFiltros}
            <div class="incidencias-vacia">
              <p>No se encontraron incidencias con los filtros seleccionados.</p>
              <a class="btn" href="/incidencias">Limpiar filtros</a>
            </div>
          `;
        }
        return `
          ${formularioFiltros}
          <div class="incidencias-vacia">
            <p>Aún no hay incidencias registradas.</p>
            <a class="btn" href="/incidencias/nueva">Registrar la primera incidencia</a>
          </div>
        `;
      }

      return `
        ${formularioFiltros}
        <div class="incidencias-grid">
          ${incidenciasVisibles
            .map((incidencia) => {
              const idIncidencia = incidencia.id_incidencia ?? '';
              const ultimoDiagnostico = incidencia.ultimo_diagnostico_fmt
                ? `<p><strong>Último diagnóstico:</strong> ${escapeHtml(incidencia.ultimo_diagnostico_fmt)}</p>`
                : '';
              const estadoNormalizado = String(incidencia.estado || '').toLowerCase();
              const claseEstado = estadoNormalizado
                ? ` incidencia-card__estado--${escapeHtml(estadoNormalizado)}`
                : '';
              const estaCerrada = estadoNormalizado === 'cerrada';

              const atributosAccionDeshabilitada = estaCerrada
                ? ' aria-disabled="true" tabindex="-1" data-accion-deshabilitada'
                : '';

              const opcionesEstado = Array.isArray(estados)
                ? estados
                    .map((estado) => {
                      const esActual = incidencia.estado === estado;
                      const disabled = esActual ? ' disabled' : '';
                      return `
                        <button
                          type="submit"
                          name="estado"
                          value="${escapeAttr(estado)}"
                          class="incidencia-card__estado-opcion"
                          data-estado-opcion${disabled}
                        >
                          ${escapeHtml(formatearEtiqueta(estado))}
                        </button>
                      `;
                    })
                    .join('')
                : '';

              const claseCerrada = estaCerrada ? ' incidencia-card--cerrada' : '';

              return `
                <article class="incidencia-card${claseCerrada}">
                  <header class="incidencia-card__header">
                    <div>
                      <h3>Incidencia</h3>
                      <p class="incidencia-card__activo">${escapeHtml(incidencia.activo_nombre || 'Activo sin nombre')}</p>
                    </div>
                    <div class="incidencia-card__estado-control" data-estado-control>
                      <form
                        method="post"
                        action="/incidencias/${escapeAttr(idIncidencia)}/diagnostico/estado"
                        class="incidencia-card__estado-form"
                      >
                        <input type="hidden" name="_csrf" value="${escapeAttr(tokenCsrf)}">
                        <button
                          type="button"
                          class="incidencia-card__estado-btn incidencia-card__estado${claseEstado}"
                          data-estado-toggle
                          aria-haspopup="true"
                          aria-expanded="false"
                        >
                          <span>${escapeHtml(formatearEtiqueta(incidencia.estado || ''))}</span>
                          <span class="incidencia-card__estado-icon" aria-hidden="true">▾</span>
                        </button>
                        <div class="incidencia-card__estado-menu" data-estado-menu hidden>
                          ${opcionesEstado}
                        </div>
                      </form>
                    </div>
                  </header>

                  <dl class="incidencia-card__datos">
                    <div>
                      <dt>Prioridad</dt>
                      <dd>${escapeHtml(formatearEtiqueta(incidencia.prioridad || ''))}</dd>
                    </div>
                    <div>
                      <dt>Tipo</dt>
                      <dd>${escapeHtml(formatearEtiqueta(incidencia.tipo_incidencia || ''))}</dd>
                    </div>
                    <div>
                      <dt>Origen</dt>
                      <dd>${escapeHtml(formatearEtiqueta(incidencia.origen_incidencia || ''))}</dd>
                    </div>
                    <div>
                      <dt>Referencia</dt>
                      <dd>${escapeHtml(idIncidencia || 'Sin folio')}</dd>
                    </div>
                    <div>
                      <dt>Número de serie</dt>
                      <dd>${escapeHtml(incidencia.numero_serie || 'No registrado')}</dd>
                    </div>
                    <div>
                      <dt>Placa</dt>
                      <dd>${escapeHtml(incidencia.placa_activo || 'No registrada')}</dd>
                    </div>
                  </dl>

                  <div class="incidencia-card__descripcion">
                    <h4>Descripción del problema</h4>
                    <p>${multilinea(incidencia.descripcion_problema || 'Sin descripción')}</p>
                  </div>

                  <footer class="incidencia-card__footer">
                    <div class="incidencia-card__detalles">
                      <p><strong>Reportada por:</strong> ${escapeHtml(incidencia.contacto_reporte || incidencia.usuario_reporta || 'No registrado')}</p>
                      ${ultimoDiagnostico}
                    </div>
                    <div class="incidencia-card__acciones">
                      <a class="btn-secundario" href="/incidencias/${escapeHtml(idIncidencia)}/editar"${atributosAccionDeshabilitada}>Editar datos</a>
                      <a class="btn" href="/incidencias/${escapeHtml(idIncidencia)}/diagnostico"${atributosAccionDeshabilitada}>Registrar diagnóstico</a>
                    </div>
                  </footer>
                </article>
              `;
            })
            .join('')}
        </div>
      `;
    })()}
  </section>

  <script>
    (() => {
      const controls = Array.from(document.querySelectorAll('[data-estado-control]'));

      const closeAll = (exception) => {
        controls.forEach((control) => {
          if (exception && control === exception) return;
          const toggle = control.querySelector('[data-estado-toggle]');
          const menu = control.querySelector('[data-estado-menu]');
          if (!toggle || !menu) return;
          toggle.setAttribute('aria-expanded', 'false');
          menu.hidden = true;
        });
      };

      controls.forEach((control) => {
        const toggle = control.querySelector('[data-estado-toggle]');
        const menu = control.querySelector('[data-estado-menu]');
        if (!toggle || !menu) return;

        toggle.addEventListener('click', (event) => {
          event.preventDefault();
          const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
          closeAll(control);
          toggle.setAttribute('aria-expanded', String(!isExpanded));
          menu.hidden = isExpanded;
        });
      });

      document.addEventListener('click', (event) => {
        const control = event.target.closest('[data-estado-control]');
        if (!control) {
          closeAll();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeAll();
        }
      });
    })();
  </script>
` }) %>

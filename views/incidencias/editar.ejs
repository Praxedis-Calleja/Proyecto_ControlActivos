<%- include('../layouts/base', { body: `
  <section class="incidencias-form">
    <h2>Editar incidencia</h2>
    <p class="section-description">
      Actualiza los datos capturados originalmente para mantener la trazabilidad del reporte y sus seguimientos.
    </p>

    ${ok ? `<div class="ok">Incidencia actualizada correctamente</div>` : ''}

    ${(errores && errores.length)
      ? `<div class="alert">${errores.map((err) => `<div>${err}</div>`).join('')}</div>`
      : ''}

    ${(() => {
      const escapeHtml = (texto = '') =>
        String(texto)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const escapeAttr = (texto = '') => escapeHtml(texto);

      const formatearEtiqueta = (valor) =>
        String(valor)
          .toLowerCase()
          .split('_')
          .map((segmento) => segmento.charAt(0).toUpperCase() + segmento.slice(1))
          .join(' ');

      const hayUsuarios = Array.isArray(usuarios) && usuarios.length > 0;
      const contactoCompleto = Boolean(
        values &&
        values.nombre_contacto_externo &&
        values.tipo_contacto_externo &&
        values.datos_contacto_externo
      );
      const selectRequired = hayUsuarios && !contactoCompleto ? ' required' : '';
      const selectDisabled = hayUsuarios ? '' : ' disabled';
      const mensajeUsuarios = hayUsuarios
        ? '<p class="campo-ayuda">Selecciona un usuario registrado o deja el campo vacío y completa el contacto externo.</p>'
        : '<p class="campo-ayuda campo-ayuda--alerta">No hay usuarios registrados. Completa la sección de contacto externo para identificar quién reporta la incidencia.</p>';

      return `
        <form method="post" action="/incidencias/${incidenciaId}/editar" class="form-incidencia">
          <div class="campo">
            <label for="id_activo">Activo involucrado</label>
            <select name="id_activo" id="id_activo" required>
              <option value="">Selecciona un activo</option>
              ${(activos || [])
                .map((activo) => {
                  const texto = [activo.marca, activo.modelo, activo.numero_serie]
                    .filter(Boolean)
                    .join(' · ') || 'Activo sin referencia';
                  const seleccionado = String((values && values.id_activo) || '') === String(activo.id_activo);
                  return `<option value="${activo.id_activo}" ${seleccionado ? 'selected' : ''}>${texto}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="id_usuario">Usuario que reporta</label>
            <select name="id_usuario" id="id_usuario"${selectRequired}${selectDisabled}>
              <option value="">Selecciona quien reporta</option>
              ${(usuarios || [])
                .map((usuario) => {
                  const nombre = [usuario.nombre, usuario.apellido].filter(Boolean).join(' ');
                  const seleccionado = String((values && values.id_usuario) || '') === String(usuario.id_usuario);
                  const rol = usuario.rol ? formatearEtiqueta(usuario.rol) : '';
                  const etiquetaRol = rol ? ` (${rol})` : '';
                  return `<option value="${usuario.id_usuario}" ${seleccionado ? 'selected' : ''}>${nombre || 'Usuario sin referencia'}${etiquetaRol}</option>`;
                })
                .join('')}
            </select>
            ${mensajeUsuarios}
          </div>

          <fieldset class="form-incidencia__contacto">
            <legend>Contacto externo</legend>
            <p class="form-incidencia__contacto-nota">
              ${hayUsuarios
                ? 'Completa esta sección solo si la persona que reporta no está registrada.'
                : 'Captura estos datos para identificar a la persona que reporta la incidencia.'}
            </p>
            <div class="form-incidencia__contacto-grid">
              <div class="campo">
                <label for="nombre_contacto_externo">Nombre completo</label>
                <input
                  id="nombre_contacto_externo"
                  name="nombre_contacto_externo"
                  value="${escapeAttr((values && values.nombre_contacto_externo) || '')}"
                  placeholder="Nombre de la persona que reporta"
                  autocomplete="name"
                >
              </div>
              <div class="campo">
                <label for="tipo_contacto_externo">Tipo de contacto</label>
                <input
                  id="tipo_contacto_externo"
                  name="tipo_contacto_externo"
                  value="${escapeAttr((values && values.tipo_contacto_externo) || '')}"
                  placeholder="Ej. Teléfono, Correo, Empresa"
                  autocomplete="off"
                >
              </div>
              <div class="campo">
                <label for="datos_contacto_externo">Datos de contacto</label>
                <input
                  id="datos_contacto_externo"
                  name="datos_contacto_externo"
                  value="${escapeAttr((values && values.datos_contacto_externo) || '')}"
                  placeholder="Ej. 55 0000 0000 / correo@example.com"
                  autocomplete="off"
                >
              </div>
            </div>
          </fieldset>

          <div class="campo">
            <label for="tipo_incidencia">Tipo de incidencia</label>
            <select name="tipo_incidencia" id="tipo_incidencia" required>
              <option value="">Selecciona un tipo</option>
              ${(tiposIncidencia || [])
                .map((tipo) => {
                  const seleccionado = String((values && values.tipo_incidencia) || '') === tipo;
                  return `<option value="${tipo}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(tipo)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="origen_incidencia">Origen de la incidencia</label>
            <select name="origen_incidencia" id="origen_incidencia" required>
              <option value="">Selecciona un origen</option>
              ${(origenesIncidencia || [])
                .map((origen) => {
                  const seleccionado = String((values && values.origen_incidencia) || '') === origen;
                  return `<option value="${origen}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(origen)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="descripcion_problema">Descripción del problema</label>
            <textarea id="descripcion_problema" name="descripcion_problema" rows="4" required>${(values && values.descripcion_problema) || ''}</textarea>
          </div>

          <div class="campo">
            <label for="prioridad">Prioridad</label>
            <select name="prioridad" id="prioridad" required>
              <option value="">Selecciona prioridad</option>
              ${(prioridades || [])
                .map((prioridad) => {
                  const seleccionado = String((values && values.prioridad) || '') === prioridad;
                  return `<option value="${prioridad}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(prioridad)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="estado">Estado</label>
            <select name="estado" id="estado" required>
              <option value="">Selecciona estado</option>
              ${(estados || [])
                .map((estado) => {
                  const seleccionado = String((values && values.estado) || '') === estado;
                  return `<option value="${estado}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(estado)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="cerrada_en">Fecha y hora de cierre (opcional)</label>
            <input
              type="datetime-local"
              id="cerrada_en"
              name="cerrada_en"
              value="${(values && values.cerrada_en) || ''}"
            >
          </div>

          <input type="hidden" name="_csrf" value="${csrfToken}">
          <div class="form-incidencia__acciones">
            <a class="btn-secundario" href="/incidencias/${incidenciaId}/diagnostico">Ver seguimiento</a>
            <button type="submit">Guardar cambios</button>
          </div>
        </form>
      `;
    })()}
  </section>
` }) %>

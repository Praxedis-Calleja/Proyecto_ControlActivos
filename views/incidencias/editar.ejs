<%- include('../layouts/base', { body: `
  <section class="incidencias-form">
    <h2>Editar incidencia</h2>
    <p class="section-description">
      Actualiza los datos capturados originalmente para mantener la trazabilidad del reporte y sus seguimientos.
    </p>

    ${ok ? `<div class="ok">Incidencia actualizada correctamente</div>` : ''}

    ${(errores && errores.length)
      ? `<div class="alert">${errores.map((err) => `<div>${err}</div>`).join('')}</div>`
      : ''}

    ${(() => {
      const formatearEtiqueta = (valor) =>
        String(valor)
          .toLowerCase()
          .split('_')
          .map((segmento) => segmento.charAt(0).toUpperCase() + segmento.slice(1))
          .join(' ');
      const usaContactoExterno = String((values && values.usa_contacto_externo) || '') === '1';

      return `
        <form method="post" action="/incidencias/${incidenciaId}/editar" class="form-incidencia" data-js="form-incidencia">
          <div class="campo">
            <label for="id_activo">Activo involucrado</label>
            <select name="id_activo" id="id_activo" required>
              <option value="">Selecciona un activo</option>
              ${(activos || [])
                .map((activo) => {
                  const texto = [activo.marca, activo.modelo, activo.numero_serie]
                    .filter(Boolean)
                    .join(' · ') || 'Activo sin referencia';
                  const seleccionado = String((values && values.id_activo) || '') === String(activo.id_activo);
                  return `<option value="${activo.id_activo}" ${seleccionado ? 'selected' : ''}>${texto}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo" data-campo-usuario>
            <label for="id_usuario">Usuario que reporta</label>
            <select name="id_usuario" id="id_usuario" required>
              <option value="">Selecciona quien reporta</option>
              ${(usuarios || [])
                .map((usuario) => {
                  const nombre = [usuario.nombre, usuario.apellido].filter(Boolean).join(' ');
                  const seleccionado = String((values && values.id_usuario) || '') === String(usuario.id_usuario);
                  const rol = usuario.rol ? formatearEtiqueta(usuario.rol) : '';
                  const etiquetaRol = rol ? ` (${rol})` : '';
                  return `<option value="${usuario.id_usuario}" ${seleccionado ? 'selected' : ''}>${nombre || 'Usuario sin referencia'}${etiquetaRol}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo campo--toggle-contacto">
            <button type="button" class="btn-secundario" data-toggle-contacto>
              ${usaContactoExterno ? 'Capturar usuario registrado' : 'Usar contacto externo'}
            </button>
            <p class="campo__ayuda">
              Activa esta opción si la incidencia fue reportada por una persona no registrada en el sistema.
            </p>
            <input type="hidden" name="usa_contacto_externo" id="usa_contacto_externo" value="${
              usaContactoExterno ? '1' : '0'
            }">
          </div>

          <div class="grupo-contacto-externo" data-contacto-externo ${
            usaContactoExterno ? '' : 'hidden'
          }>
            <div class="campo">
              <h3>Contacto externo</h3>
              <p class="campo__ayuda">
                Actualiza los datos de contacto de la persona externa responsable del reporte.
              </p>
            </div>

            <div class="campo">
              <label for="nombre_contacto_externo">Nombre del contacto externo</label>
              <input
                type="text"
                id="nombre_contacto_externo"
                name="nombre_contacto_externo"
                maxlength="120"
                value="${(values && values.nombre_contacto_externo) || ''}"
                data-require-when-externo="true"
              >
            </div>

            <div class="campo">
              <label for="tipo_contacto_externo">Tipo de contacto externo</label>
              <input
                type="text"
                id="tipo_contacto_externo"
                name="tipo_contacto_externo"
                maxlength="50"
                value="${(values && values.tipo_contacto_externo) || ''}"
              >
            </div>

            <div class="campo">
              <label for="datos_contacto_externo">Datos de contacto externo</label>
              <input
                type="text"
                id="datos_contacto_externo"
                name="datos_contacto_externo"
                maxlength="120"
                value="${(values && values.datos_contacto_externo) || ''}"
                data-require-when-externo="true"
              >
            </div>
          </div>

          <div class="campo">
            <h3>Contacto externo (opcional)</h3>
            <p class="campo__ayuda">
              Actualiza estos campos si la incidencia fue reportada por una persona no registrada en el sistema.
            </p>
          </div>

          <div class="campo">
            <label for="nombre_contacto_externo">Nombre del contacto externo</label>
            <input
              type="text"
              id="nombre_contacto_externo"
              name="nombre_contacto_externo"
              maxlength="120"
              value="${(values && values.nombre_contacto_externo) || ''}"
            >
          </div>

          <div class="campo">
            <label for="tipo_contacto_externo">Tipo de contacto externo</label>
            <input
              type="text"
              id="tipo_contacto_externo"
              name="tipo_contacto_externo"
              maxlength="50"
              value="${(values && values.tipo_contacto_externo) || ''}"
            >
          </div>

          <div class="campo">
            <label for="datos_contacto_externo">Datos de contacto externo</label>
            <input
              type="text"
              id="datos_contacto_externo"
              name="datos_contacto_externo"
              maxlength="120"
              value="${(values && values.datos_contacto_externo) || ''}"
            >
          </div>

          <div class="campo">
            <label for="tipo_incidencia">Tipo de incidencia</label>
            <select name="tipo_incidencia" id="tipo_incidencia" required>
              <option value="">Selecciona un tipo</option>
              ${(tiposIncidencia || [])
                .map((tipo) => {
                  const seleccionado = String((values && values.tipo_incidencia) || '') === tipo;
                  return `<option value="${tipo}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(tipo)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="origen_incidencia">Origen de la incidencia</label>
            <select name="origen_incidencia" id="origen_incidencia" required>
              <option value="">Selecciona un origen</option>
              ${(origenesIncidencia || [])
                .map((origen) => {
                  const seleccionado = String((values && values.origen_incidencia) || '') === origen;
                  return `<option value="${origen}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(origen)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="descripcion_problema">Descripción del problema</label>
            <textarea id="descripcion_problema" name="descripcion_problema" rows="4" required>${(values && values.descripcion_problema) || ''}</textarea>
          </div>

          <div class="campo">
            <label for="prioridad">Prioridad</label>
            <select name="prioridad" id="prioridad" required>
              <option value="">Selecciona prioridad</option>
              ${(prioridades || [])
                .map((prioridad) => {
                  const seleccionado = String((values && values.prioridad) || '') === prioridad;
                  return `<option value="${prioridad}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(prioridad)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="estado">Estado</label>
            <select name="estado" id="estado" required>
              <option value="">Selecciona estado</option>
              ${(estados || [])
                .map((estado) => {
                  const seleccionado = String((values && values.estado) || '') === estado;
                  return `<option value="${estado}" ${seleccionado ? 'selected' : ''}>${formatearEtiqueta(estado)}</option>`;
                })
                .join('')}
            </select>
          </div>

          <div class="campo">
            <label for="cerrada_en">Fecha y hora de cierre (opcional)</label>
            <input
              type="datetime-local"
              id="cerrada_en"
              name="cerrada_en"
              value="${(values && values.cerrada_en) || ''}"
            >
          </div>

          <input type="hidden" name="_csrf" value="${csrfToken}">
          <div class="form-incidencia__acciones">
            <a class="btn-secundario" href="/incidencias/${incidenciaId}/diagnostico">Ver seguimiento</a>
            <button type="submit">Guardar cambios</button>
          </div>
        </form>
        <script>
          (() => {
            const form = document.querySelector('[data-js="form-incidencia"]');
            if (!form) return;

            const toggleBtn = form.querySelector('[data-toggle-contacto]');
            const hiddenInput = form.querySelector('#usa_contacto_externo');
            const campoUsuario = form.querySelector('[data-campo-usuario]');
            const contenedorExterno = form.querySelector('[data-contacto-externo]');
            if (!toggleBtn || !hiddenInput || !campoUsuario || !contenedorExterno) {
              return;
            }

            const selectUsuario = campoUsuario.querySelector('select');
            const inputsExternos = Array.from(
              contenedorExterno.querySelectorAll('input')
            );

            const sincronizar = (usaExterno) => {
              if (selectUsuario) {
                selectUsuario.disabled = usaExterno;
                if (usaExterno) {
                  selectUsuario.value = '';
                }
              }

              inputsExternos.forEach((input) => {
                const requiere = input.dataset.requireWhenExterno === 'true';
                input.disabled = !usaExterno;
                input.required = usaExterno && requiere;
              });

              contenedorExterno.hidden = !usaExterno;
              campoUsuario.classList.toggle('campo--deshabilitado', usaExterno);
              toggleBtn.textContent = usaExterno
                ? 'Capturar usuario registrado'
                : 'Usar contacto externo';
            };

            sincronizar(hiddenInput.value === '1');

            toggleBtn.addEventListener('click', () => {
              const usaExterno = hiddenInput.value === '1';
              const nuevoEstado = !usaExterno;
              hiddenInput.value = nuevoEstado ? '1' : '0';
              sincronizar(nuevoEstado);
            });
          })();
        </script>
      `;
    })()}
  </section>
` }) %>

<%- include('../layouts/base', { body: `
  <section class="reportes-diagnostico">
    <header class="reportes-diagnostico__header">
      <div>
        <h2>Reportes de diagnóstico</h2>
        <p class="reportes-diagnostico__descripcion section-description">
          Consulta los diagnósticos registrados para los activos con incidencias, revisa los detalles técnicos y descarga los informes en PDF.
        </p>
      </div>
    </header>

    ${error ? `<div class="alert">${error}</div>` : ''}

    ${(() => {
      const escapeHtml = (texto = '') =>
        String(texto)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const escapeAttr = (texto = '') => escapeHtml(texto);

      const multilinea = (texto = '') => escapeHtml(texto).replace(/\r?\n/g, '<br>');

      if (!Array.isArray(reportes) || reportes.length === 0) {
        if (error) {
          return `
            <div class="reportes-diagnostico__vacio">
              <p>No pudimos cargar los reportes de diagnóstico en este momento.</p>
            </div>
          `;
        }

        return `
          <div class="reportes-diagnostico__vacio">
            <p>Aún no se han registrado diagnósticos.</p>
            <p>Cuando registres un diagnóstico desde una incidencia aparecerá en esta sección.</p>
          </div>
        `;
      }

      return `
        <div class="reportes-diagnostico__grid">
          ${reportes
            .map((reporte) => {
              const evidencia = reporte.evidencia
                ? `<p><strong>Evidencia:</strong> ${escapeHtml(reporte.evidencia)}</p>`
                : '';

              const accionesBaja = reporte.reporteBaja
                ? `
                      <a class="btn-secundario" href="${escapeAttr(reporte.reporteBaja.url)}" target="_blank" rel="noopener">Ver PDF de baja</a>
                      <a class="btn" href="${escapeAttr(reporte.reporteBaja.url)}?descargar=1" download>Descargar PDF de baja</a>
                    `
                : '';

              const resumenBaja = reporte.reporteBaja
                ? `
                      <div class="reporte-diagnostico-card__texto">
                        <h5>Reporte de baja asociado</h5>
                        <p><strong>Identificador:</strong> #${escapeHtml(reporte.reporteBaja.id)}</p>
                        <p><strong>Fecha:</strong> ${escapeHtml(reporte.reporteBaja.fecha)}</p>
                      </div>
                    `
                : '';

              return `
                <article class="reporte-diagnostico-card">
                  <header class="reporte-diagnostico-card__header">
                    <div>
                      <h3>Diagnóstico #${escapeHtml(reporte.id)}</h3>
                      <p class="reporte-diagnostico-card__subtitulo">
                        Incidencia #${escapeHtml(reporte.incidenciaId)} · ${escapeHtml(reporte.fechaDiagnostico)}
                      </p>
                    </div>
                    <div class="reporte-diagnostico-card__acciones">
                      <a class="btn-secundario" href="/incidencias/${escapeAttr(reporte.incidenciaId)}/diagnostico" rel="noopener">Ver incidencia</a>
                      <a class="btn-secundario" href="${escapeAttr(reporte.pdfUrl)}" target="_blank" rel="noopener">Ver PDF diagnóstico</a>
                      <a class="btn" href="${escapeAttr(reporte.pdfUrl)}?descargar=1" download>Descargar PDF diagnóstico</a>
                      ${accionesBaja}
                    </div>
                  </header>

                  <section class="reporte-diagnostico-card__contenido">
                    <div class="reporte-diagnostico-card__bloque">
                      <h4>Activo diagnosticado</h4>
                      <dl>
                        <div>
                          <dt>Activo</dt>
                          <dd>${escapeHtml(reporte.activo.nombre)}</dd>
                        </div>
                        <div>
                          <dt>Número de serie</dt>
                          <dd>${escapeHtml(reporte.activo.numeroSerie)}</dd>
                        </div>
                        <div>
                          <dt>Placa</dt>
                          <dd>${escapeHtml(reporte.activo.placa)}</dd>
                        </div>
                      </dl>
                    </div>

                    <div class="reporte-diagnostico-card__bloque">
                      <h4>Detalle del diagnóstico</h4>
                      <p><strong>Registrado:</strong> ${escapeHtml(reporte.creadoEn)}</p>
                      <p><strong>Técnico:</strong> ${escapeHtml(reporte.tecnico)}</p>
                      <p><strong>Estado de la incidencia:</strong> ${escapeHtml(reporte.incidencia.estado)}</p>
                      <p><strong>Prioridad:</strong> ${escapeHtml(reporte.incidencia.prioridad)}</p>
                      <div class="reporte-diagnostico-card__texto">
                        <h5>Descripción reportada</h5>
                        <p>${multilinea(reporte.descripcionProblema || 'Sin descripción registrada.')}</p>
                      </div>
                      <div class="reporte-diagnostico-card__texto">
                        <h5>Trabajo realizado</h5>
                        <p>${multilinea(reporte.trabajo || 'Sin información registrada.')}</p>
                      </div>
                      <div class="reporte-diagnostico-card__texto">
                        <h5>Diagnóstico técnico</h5>
                        <p>${multilinea(reporte.diagnostico || 'Sin diagnóstico registrado.')}</p>
                      </div>
                      ${resumenBaja}
                      ${evidencia}
                    </div>
                  </section>
                </article>
              `;
            })
            .join('')}
        </div>
      `;
    })()}
  </section>
` }) %>

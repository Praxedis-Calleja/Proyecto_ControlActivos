<%- include('../layouts/base', { body: `
  <section class="diagnostico-incidencia">
    <h2>Diagnóstico de la incidencia #${incidencia.id_incidencia}</h2>
    <p class="section-description">
      Completa la evaluación técnica del activo, documenta el trabajo realizado y genera los reportes necesarios.
    </p>

    ${ok
      ? `<div class="ok">
          Diagnóstico registrado correctamente.
          ${diagnosticoIdCreado
            ? `<a class="btn-secundario" href="/incidencias/${incidencia.id_incidencia}/diagnostico/pdf/${diagnosticoIdCreado}" target="_blank" rel="noopener">Descargar reporte en PDF</a>`
            : ''}
        </div>`
      : ''}

    ${estadoActualizado
      ? '<div class="ok">Estado de la incidencia actualizado correctamente.</div>'
      : ''}

    ${estadoError
      ? '<div class="alert">No se pudo actualizar el estado de la incidencia. Intenta nuevamente.</div>'
      : ''}

    ${(errores && errores.length)
      ? `<div class="alert">${errores.map((err) => `<div>${err}</div>`).join('')}</div>`
      : ''}

    ${(() => {
      const escapeHtml = (texto = '') =>
        String(texto)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const escapeAttr = (texto = '') => escapeHtml(texto);

      const formatearFechaVista = (valor) => {
        if (!valor) return 'Sin registro';
        try {
          const fecha = new Date(valor);
          if (Number.isNaN(fecha.getTime())) return escapeHtml(valor);
          return new Intl.DateTimeFormat('es-MX', {
            dateStyle: 'medium',
            timeStyle: 'short'
          }).format(fecha);
        } catch (error) {
          return escapeHtml(valor);
        }
      };

      const multilinea = (texto = '') =>
        escapeHtml(texto).replace(/\r?\n/g, '<br>');

      const opcionesEstado = Array.isArray(estados)
        ? estados
            .map((estado) => {
              const seleccionado = incidencia.estado === estado ? 'selected' : '';
              const texto = estado.replace(/_/g, ' ');
              return `<option value="${escapeAttr(estado)}" ${seleccionado}>${escapeHtml(texto)}</option>`;
            })
            .join('')
        : '';

      const infoIncidencia = `
        <article class="resumen-incidencia">
          <h3>Resumen de la incidencia</h3>
          <dl>
            <div>
              <dt>Activo</dt>
              <dd>${escapeHtml(incidencia.activo_nombre || 'Sin información')}</dd>
            </div>
            <div>
              <dt>Número de serie</dt>
              <dd>${escapeHtml(incidencia.numero_serie || 'No registrado')}</dd>
            </div>
            <div>
              <dt>Placa</dt>
              <dd>${escapeHtml(incidencia.placa_activo || 'No registrada')}</dd>
            </div>
            <div>
              <dt>Reportada por</dt>
              <dd>${escapeHtml(incidencia.nombre_reporta || 'No registrado')}</dd>
            </div>
            <div>
              <dt>Estado</dt>
              <dd>${escapeHtml(incidencia.estado || 'Sin estado')}</dd>
            </div>
            <div>
              <dt>Prioridad</dt>
              <dd>${escapeHtml(incidencia.prioridad || 'Sin prioridad')}</dd>
            </div>
            <div>
              <dt>Tipo / Origen</dt>
              <dd>${escapeHtml(incidencia.tipo_incidencia || 'Sin tipo')} · ${escapeHtml(incidencia.origen_incidencia || 'Sin origen')}</dd>
            </div>
            <div>
              <dt>Creada en</dt>
              <dd>${formatearFechaVista(incidencia.creada_en)}</dd>
            </div>
          </dl>
          <div class="descripcion-problema">
            <h4>Descripción reportada</h4>
            <p>${multilinea(incidencia.descripcion_problema || 'Sin descripción')}</p>
          </div>
          <div class="acciones-incidencia">
            <a class="btn-secundario" href="/incidencias/${incidencia.id_incidencia}/editar">Editar datos de la incidencia</a>
            <form method="post" action="/incidencias/${incidencia.id_incidencia}/diagnostico/estado" class="acciones-incidencia__form">
              <label for="estado-incidencia">Cambiar estado</label>
              <div class="acciones-incidencia__controles">
                <select id="estado-incidencia" name="estado">
                  ${opcionesEstado}
                </select>
                <input type="hidden" name="_csrf" value="${csrfToken}">
                <button type="submit" class="btn">Actualizar estado</button>
              </div>
            </form>
          </div>
        </article>
      `;

      const formulario = `
        <form
          method="post"
          action="/incidencias/${incidencia.id_incidencia}/diagnostico"
          class="form-diagnostico"
          data-form-diagnostico
        >
          <div class="campo">
            <label for="fecha_diagnostico">Fecha de diagnóstico</label>
            <input
              type="date"
              id="fecha_diagnostico"
              name="fecha_diagnostico"
              value="${escapeAttr(values.fecha_diagnostico || '')}"
              required
            >
          </div>

          <div class="campo">
            <label for="descripcion_trabajo">Trabajo realizado</label>
            <textarea id="descripcion_trabajo" name="descripcion_trabajo" rows="4" required>${escapeHtml(values.descripcion_trabajo || '')}</textarea>
          </div>

          <div class="campo campo-flex">
            <div>
              <label for="procesador">Procesador diagnosticado</label>
              <input id="procesador" name="procesador" value="${escapeAttr(values.procesador || incidencia.procesador || '')}">
            </div>
            <div>
              <label for="memoria_ram">Memoria RAM</label>
              <input id="memoria_ram" name="memoria_ram" value="${escapeAttr(values.memoria_ram || incidencia.memoria_ram || '')}">
            </div>
            <div>
              <label for="almacenamiento">Almacenamiento</label>
              <input id="almacenamiento" name="almacenamiento" value="${escapeAttr(values.almacenamiento || incidencia.almacenamiento || '')}">
            </div>
          </div>

          <div class="campo">
            <label for="diagnostico">Diagnóstico técnico</label>
            <textarea id="diagnostico" name="diagnostico" rows="4" required>${escapeHtml(values.diagnostico || '')}</textarea>
          </div>

          <fieldset class="campo">
            <legend>¿El activo debe darse de baja?</legend>
            <div class="opciones">
              <label>
                <input type="radio" name="requiere_baja" value="SI" ${values.requiere_baja === 'SI' ? 'checked' : ''}>
                Sí
              </label>
              <label>
                <input type="radio" name="requiere_baja" value="NO" ${values.requiere_baja !== 'SI' ? 'checked' : ''}>
                No
              </label>
            </div>
          </fieldset>

          <div class="grupo-baja" data-baja-extra ${values.requiere_baja === 'SI' ? '' : 'hidden'}>
            <p class="campo-nota">Completa la siguiente información únicamente si el activo será dado de baja.</p>

            <div class="campo">
              <label for="motivo_baja">Motivo de baja <small>(requerido si aplica)</small></label>
              <textarea id="motivo_baja" name="motivo_baja" rows="3">${escapeHtml(values.motivo_baja || '')}</textarea>
            </div>

            <div class="campo">
              <label for="autorizado_por">Autorizado por <small>(requerido si aplica)</small></label>
              <input
                type="text"
                id="autorizado_por"
                name="autorizado_por"
                value="${escapeAttr(values.autorizado_por || '')}"
              >
            </div>

            <div class="campo">
              <label for="observaciones_baja">Observaciones adicionales</label>
              <textarea id="observaciones_baja" name="observaciones_baja" rows="3">${escapeHtml(values.observaciones_baja || '')}</textarea>
            </div>
          </div>

          <div class="campo">
            <label for="evidencia_url">Evidencia (URL opcional)</label>
            <input
              type="url"
              id="evidencia_url"
              name="evidencia_url"
              value="${escapeAttr(values.evidencia_url || '')}"
              placeholder="https://..."
            >
          </div>

          <div class="campo">
            <label for="firma_tecnico">Firma del técnico</label>
            <input
              type="text"
              id="firma_tecnico"
              name="firma_tecnico"
              value="${escapeAttr(values.firma_tecnico || '')}"
              required
            >
            <small>Esta firma se imprimirá en el reporte PDF.</small>
          </div>

          <input type="hidden" name="_csrf" value="${csrfToken}">
          <button type="submit">Guardar diagnóstico</button>
        </form>
      `;

      const formularioOBloqueo = permiteDiagnostico
        ? formulario
        : `
          <div class="form-diagnostico form-diagnostico--bloqueada">
            <p>La incidencia está cerrada, no es posible registrar nuevos diagnósticos ni generar reportes de baja.</p>
          </div>
        `;

      const listadoReportesDiagnostico = `
        <section class="diagnosticos-reportes" id="diagnosticos-reportes">
          <h3>Reportes de diagnóstico</h3>
          ${diagnosticos && diagnosticos.length
            ? `<ul class="diagnosticos-reportes-lista">
                ${diagnosticos
                  .map((registro) => {
                    const enlaceDiagnostico = `/incidencias/${incidencia.id_incidencia}/diagnostico/pdf/${registro.id_diagnostico}`;
                    const enlaceBaja = registro.reporte_baja
                      ? `<a class="btn-secundario" href="${escapeAttr(registro.reporte_baja.url)}" target="_blank" rel="noopener">Reporte de baja</a>`
                      : '';
                    const etiquetaBaja = registro.reporte_baja
                      ? `<small class="diagnosticos-reporte-item__detalle">Folio baja: ${escapeHtml(registro.reporte_baja.folio)}</small>`
                      : '<small class="diagnosticos-reporte-item__detalle diagnosticos-reporte-item__detalle--sin">Sin reporte de baja</small>';

                    return `
                      <li class="diagnosticos-reporte-item">
                        <div>
                          <strong>Diagnóstico #${registro.id_diagnostico}</strong>
                          <span> · ${escapeHtml(registro.fecha_diagnostico_fmt)}</span>
                          ${etiquetaBaja}
                        </div>
                        <div class="acciones">
                          <a class="btn-secundario" href="${escapeAttr(enlaceDiagnostico)}" target="_blank" rel="noopener">Reporte de diagnóstico</a>
                          ${enlaceBaja}
                        </div>
                      </li>
                    `;
                  })
                  .join('')}
              </ul>`
            : '<p>No se han generado reportes de diagnóstico.</p>'}
        </section>
      `;

      return `
        <div class="diagnostico-grid">
          ${infoIncidencia}
          ${formularioOBloqueo}
        </div>
        ${listadoReportesDiagnostico}
        <script>
          (() => {
            const form = document.querySelector('[data-form-diagnostico]');
            if (!form) return;
            const toggleContainer = () => {
              const seleccionado = form.querySelector('input[name="requiere_baja"]:checked');
              const requiereBaja = seleccionado && seleccionado.value === 'SI';
              const contenedor = form.querySelector('[data-baja-extra]');
              if (!contenedor) return;
              if (requiereBaja) {
                contenedor.removeAttribute('hidden');
              } else {
                contenedor.setAttribute('hidden', '');
              }
            };

            form.querySelectorAll('input[name="requiere_baja"]').forEach((radio) => {
              radio.addEventListener('change', toggleContainer);
            });

            toggleContainer();
          })();
        </script>
      `;
    })()}
  </section>
` }) %>

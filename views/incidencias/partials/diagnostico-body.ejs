<%
  const formatearFechaVista = (valor) => {
    if (!valor) return 'Sin registro';
    try {
      const fecha = new Date(valor);
      if (Number.isNaN(fecha.getTime())) return valor;
      return new Intl.DateTimeFormat('es-MX', {
        dateStyle: 'medium',
        timeStyle: 'short'
      }).format(fecha);
    } catch (error) {
      return valor;
    }
  };

  const escapeHtml = (texto = '') =>
    String(texto)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

  const multilinea = (texto = '') => escapeHtml(texto).replace(/\r?\n/g, '<br>');

  const configEvidencia = evidenciaConfig || {};
  const evidenciaMaxImagenes = Number(configEvidencia.maxImagenes) || 0;
  const evidenciaMaxPesoBytes = Number(configEvidencia.maxPesoBytes) || 0;
  const evidenciaMaxPesoMB = configEvidencia.maxPesoMB || '0';
  const evidenciaFormatos = configEvidencia.formatosTexto || 'JPG, PNG';
  const requiereBajaSeleccionada = values && values.requiere_baja === 'SI';
%>

<section class="diagnostico-incidencia">
  <h2>Diagnóstico de la incidencia</h2>
  <p class="section-description">
    Completa la evaluación técnica del activo, documenta el trabajo realizado y genera los reportes necesarios.
  </p>
  <% if (ok) { %>
    <div class="ok">
      Diagnóstico registrado correctamente.
      <% if (diagnosticoIdCreado) { %>
        <a
          class="btn-secundario"
          href="/incidencias/<%= incidencia.id_incidencia %>/diagnostico/pdf/<%= diagnosticoIdCreado %>"
          target="_blank"
          rel="noopener"
        >Descargar reporte en PDF</a>
      <% } %>
    </div>
  <% } %>

  <% if (reporteBajaCreado) { %>
    <div class="ok">
      Reporte de baja generado correctamente<%= reporteBajaCreado.id ? ` (#${reporteBajaCreado.id})` : '' %>.
      <a class="btn-secundario" href="<%= reporteBajaCreado.url %>" target="_blank" rel="noopener">Ver reporte</a>
      <a class="btn" href="<%= reporteBajaCreado.url %>?descargar=1" download>Descargar PDF</a>
    </div>
  <% } %>

  <% if (estadoActualizado) { %>
    <div class="ok">Estado de la incidencia actualizado correctamente.</div>
  <% } %>

  <% if (estadoError) { %>
    <div class="alert">No se pudo actualizar el estado de la incidencia. Intenta nuevamente.</div>
  <% } %>

  <% if (Array.isArray(errores) && errores.length) { %>
    <div class="alert">
      <% errores.forEach((mensaje) => { %>
        <div><%= mensaje %></div>
      <% }) %>
    </div>
  <% } %>
  <div class="diagnostico-grid">
    <article class="resumen-incidencia">
      <h3>Resumen de la incidencia</h3>
      <dl>
        <div>
          <dt>Activo</dt>
          <dd><%= incidencia.activo_nombre || 'Sin información' %></dd>
        </div>
        <div>
          <dt>Número de serie</dt>
          <dd><%= incidencia.numero_serie || 'No registrado' %></dd>
        </div>
        <div>
          <dt>Placa</dt>
          <dd><%= incidencia.placa_activo || 'No registrada' %></dd>
        </div>
        <div>
          <dt>Reportada por</dt>
          <dd><%= incidencia.contacto_reporte || incidencia.nombre_reporta || 'No registrado' %></dd>
        </div>
        <div>
          <dt>Estado</dt>
          <dd><%= incidencia.estado || 'Sin estado' %></dd>
        </div>
        <div>
          <dt>Prioridad</dt>
          <dd><%= incidencia.prioridad || 'Sin prioridad' %></dd>
        </div>
        <div>
          <dt>Tipo / Origen</dt>
          <dd><%= (incidencia.tipo_incidencia || 'Sin tipo') + ' · ' + (incidencia.origen_incidencia || 'Sin origen') %></dd>
        </div>
        <div>
          <dt>Creada en</dt>
          <dd><%= formatearFechaVista(incidencia.creada_en) %></dd>
        </div>
      </dl>
      <div class="descripcion-problema">
        <h4>Descripción reportada</h4>
        <p><%- multilinea(incidencia.descripcion_problema || 'Sin descripción') %></p>
      </div>
      <div class="acciones-incidencia">
        <a class="btn-secundario" href="/incidencias/<%= incidencia.id_incidencia %>/editar">Editar datos de la incidencia</a>
        <form method="post" action="/incidencias/<%= incidencia.id_incidencia %>/diagnostico/estado" class="acciones-incidencia__form">
          <label for="estado-incidencia">Cambiar estado</label>
          <div class="acciones-incidencia__controles">
            <select id="estado-incidencia" name="estado">
              <% if (Array.isArray(estados)) { %>
                <% estados.forEach((estado) => { %>
                  <option value="<%= estado %>" <%= incidencia.estado === estado ? 'selected' : '' %>>
                    <%= estado.replace(/_/g, ' ') %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="btn">Actualizar estado</button>
          </div>
        </form>
      </div>
    </article>
    <% if (permiteDiagnostico) { %>
      <form
        method="post"
        action="/incidencias/<%= incidencia.id_incidencia %>/diagnostico"
        class="form-diagnostico"
        data-form-diagnostico
        data-max-evidencias="<%= evidenciaMaxImagenes %>"
        data-max-evidencia-size="<%= evidenciaMaxPesoBytes %>"
      >
        <div class="campo">
          <label for="fecha_diagnostico">Fecha de diagnóstico</label>
          <input
            type="date"
            id="fecha_diagnostico"
            name="fecha_diagnostico"
            value="<%= values.fecha_diagnostico || '' %>"
            required
          >
        </div>

        <div class="campo">
          <label for="descripcion_trabajo">Trabajo realizado</label>
          <textarea id="descripcion_trabajo" name="descripcion_trabajo" rows="4" required><%= values.descripcion_trabajo || '' %></textarea>
        </div>

        <div class="campo">
          <label for="tiempo_uso">Tiempo de uso</label>
          <input
            type="text"
            id="tiempo_uso"
            name="tiempo_uso"
            value="<%= values.tiempo_uso || '' %>"
            maxlength="150"
            placeholder="Ej. 2 años 4 meses"
          >
          <small>Describe el tiempo aproximado de uso del equipo.</small>
        </div>

        <div class="campo campo-flex">
          <div>
            <label for="procesador">Procesador diagnosticado</label>
            <input id="procesador" name="procesador" value="<%= values.procesador || incidencia.procesador || '' %>">
          </div>
          <div>
            <label for="memoria_ram">Memoria RAM</label>
            <input id="memoria_ram" name="memoria_ram" value="<%= values.memoria_ram || incidencia.memoria_ram || '' %>">
          </div>
          <div>
            <label for="almacenamiento">Almacenamiento</label>
            <input id="almacenamiento" name="almacenamiento" value="<%= values.almacenamiento || incidencia.almacenamiento || '' %>">
          </div>
        </div>

        <div class="campo">
          <label for="diagnostico">Diagnóstico técnico</label>
          <textarea id="diagnostico" name="diagnostico" rows="4" required><%= values.diagnostico || '' %></textarea>
        </div>

        <fieldset class="campo">
          <legend>¿El activo debe darse de baja?</legend>
          <div class="opciones">
            <label>
              <input type="radio" name="requiere_baja" value="SI" <%= requiereBajaSeleccionada ? 'checked' : '' %>>
              Sí
            </label>
            <label>
              <input type="radio" name="requiere_baja" value="NO" <%= !requiereBajaSeleccionada ? 'checked' : '' %>>
              No
            </label>
          </div>
        </fieldset>

        <div
          class="grupo-baja <%= requiereBajaSeleccionada ? '' : 'grupo-baja--inactiva' %>"
          data-baja-extra
          aria-live="polite"
          aria-disabled="<%= requiereBajaSeleccionada ? 'false' : 'true' %>"
        >
          <div class="grupo-baja__encabezado">
            <p class="campo-nota">Completa las fechas que se registrarán en el formato de baja.</p>
            <small class="grupo-baja__ayuda">Activa “Sí” en la opción anterior para habilitar estos campos.</small>
          </div>

          <div class="grupo-baja__fechas">
            <div class="campo">
              <label for="fecha_baja">Fecha de baja</label>
              <input
                type="date"
                id="fecha_baja"
                name="fecha_baja"
                value="<%= values.fecha_baja || '' %>"
                <%= requiereBajaSeleccionada ? '' : 'disabled' %>
                data-baja-campo
                data-baja-required
              >
              <small>Esta fecha se utilizará como referencia oficial del reporte de baja.</small>
            </div>

            <div class="campo">
              <label for="fecha_reimpresion">Fecha de reimpresión <small>(opcional)</small></label>
              <input
                type="date"
                id="fecha_reimpresion"
                name="fecha_reimpresion"
                value="<%= values.fecha_reimpresion || '' %>"
                <%= requiereBajaSeleccionada ? '' : 'disabled' %>
                data-baja-campo
                data-reset-on-hide
              >
              <small>Déjala en blanco si aún no existe una reimpresión del formato.</small>
            </div>
          </div>
        </div>

        <div class="campo">
          <label for="evidencia_url">Evidencia (URL opcional)</label>
          <input
            type="url"
            id="evidencia_url"
            name="evidencia_url"
            value="<%= values.evidencia_url || '' %>"
            placeholder="https://..."
          >
        </div>

        <div class="campo campo-archivos">
          <label for="evidencia_archivos">Evidencia en imágenes (opcional)</label>
          <input type="file" id="evidencia_archivos" accept="image/*" multiple>
          <small class="campo-ayuda">
            Puedes adjuntar hasta <%= evidenciaMaxImagenes %> imágenes (<%= evidenciaMaxPesoMB %> MB c/u).
          </small>
          <small class="campo-ayuda">
            Formatos permitidos: <%= evidenciaFormatos %>. Las imágenes solo se utilizan para el PDF y no se guardan en la base de datos.
          </small>
          <p class="campo-error" data-evidencia-error hidden></p>
        </div>

        <input type="hidden" name="evidencia_imagenes" id="evidencia_imagenes" value="">

        <div class="campo">
          <label for="firma_tecnico">Firma del técnico</label>
          <input
            type="text"
            id="firma_tecnico"
            name="firma_tecnico"
            value="<%= values.firma_tecnico || '' %>"
            required
          >
          <small>Esta firma se imprimirá en el reporte PDF.</small>
        </div>

        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit">Guardar diagnóstico</button>
      </form>
    <% } else { %>
      <div class="form-diagnostico form-diagnostico--bloqueada">
        <p>La incidencia está cerrada, no es posible registrar nuevos diagnósticos ni generar reportes de baja.</p>
      </div>
    <% } %>
  </div>
  

  <script>
    (() => {
      const form = document.querySelector('[data-form-diagnostico]');
      if (!form) return;
      const contenedor = form.querySelector('[data-baja-extra]');
      const fechaDiagnosticoInput = form.querySelector('#fecha_diagnostico');
      const fechaBajaInput = form.querySelector('#fecha_baja');

      const toggleContainer = () => {
        const seleccionado = form.querySelector('input[name="requiere_baja"]:checked');
        const requiereBaja = seleccionado && seleccionado.value === 'SI';
        if (!contenedor) return;

        contenedor.classList.toggle('grupo-baja--inactiva', !requiereBaja);
        contenedor.setAttribute('aria-disabled', requiereBaja ? 'false' : 'true');

        const campos = contenedor.querySelectorAll('[data-baja-campo]');
        campos.forEach((campo) => {
          campo.disabled = !requiereBaja;
          if (campo.hasAttribute('data-baja-required')) {
            campo.required = requiereBaja;
          }
          if (!requiereBaja && campo.hasAttribute('data-reset-on-hide')) {
            campo.value = '';
          }
        });

        if (requiereBaja && fechaBajaInput && fechaDiagnosticoInput && !fechaBajaInput.value) {
          fechaBajaInput.value = fechaDiagnosticoInput.value || '';
        }
      };

      form.querySelectorAll('input[name="requiere_baja"]').forEach((radio) => {
        radio.addEventListener('change', toggleContainer);
      });

      if (fechaDiagnosticoInput && fechaBajaInput) {
        fechaDiagnosticoInput.addEventListener('change', () => {
          const seleccionado = form.querySelector('input[name="requiere_baja"]:checked');
          const requiereBaja = seleccionado && seleccionado.value === 'SI';
          if (!requiereBaja) return;
          if (!fechaBajaInput.value) {
            fechaBajaInput.value = fechaDiagnosticoInput.value || '';
          }
        });
      }

      toggleContainer();

      const archivosInput = form.querySelector('#evidencia_archivos');
      const hiddenInput = form.querySelector('#evidencia_imagenes');
      const errorTarget = form.querySelector('[data-evidencia-error]');
      const maxFiles = Number(form.dataset.maxEvidencias || '0');
      const maxFileSize = Number(form.dataset.maxEvidenciaSize || '0');
      const maxFileSizeLabel = maxFileSize
        ? `${Math.round((maxFileSize / (1024 * 1024)) * 10) / 10} MB`
        : '';

      const limpiarMensaje = () => {
        if (!errorTarget) return;
        errorTarget.textContent = '';
        errorTarget.setAttribute('hidden', '');
      };

      const leerArchivo = (archivo) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('No se pudo leer una de las evidencias.'));
          reader.readAsDataURL(archivo);
        });

      const prepararImagenes = async () => {
        if (!archivosInput?.files?.length) {
          if (hiddenInput) hiddenInput.value = '';
          return [];
        }

        const archivos = Array.from(archivosInput.files);
        const seleccionados = maxFiles > 0 ? archivos.slice(0, maxFiles) : archivos;
        const imagenes = [];

        for (const archivo of seleccionados) {
          if (!archivo.type.startsWith('image/')) {
            throw new Error('Solo se permiten archivos de imagen en la evidencia.');
          }
          if (maxFileSize > 0 && archivo.size > maxFileSize) {
            const mensajeLimite = maxFileSizeLabel
              ? `Cada imagen debe pesar menos de ${maxFileSizeLabel}.`
              : 'Reduce el peso de la evidencia antes de enviarla.';
            throw new Error(mensajeLimite);
          }
          const dataUrl = await leerArchivo(archivo);
          imagenes.push(dataUrl);
        }

        return imagenes;
      };

      if (archivosInput) {
        archivosInput.addEventListener('change', () => {
          limpiarMensaje();
          if (hiddenInput) hiddenInput.value = '';
        });
      }

      form.addEventListener('submit', async (event) => {
        if (!archivosInput || !hiddenInput) return;
        if (!archivosInput.files || !archivosInput.files.length) {
          hiddenInput.value = '';
          return;
        }

        event.preventDefault();
        limpiarMensaje();

        try {
          const imagenes = await prepararImagenes();
          hiddenInput.value = imagenes.length ? JSON.stringify(imagenes) : '';
          form.submit();
        } catch (error) {
          if (errorTarget) {
            errorTarget.textContent = error.message || 'No se pudieron preparar las evidencias gráficas.';
            errorTarget.removeAttribute('hidden');
          }
        }
      });
    })();
  </script>
</section>
